# FaaS Billing ‚Äî –°–∏—Å—Ç–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞ –¥–ª—è serverless-—Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ Knative

FaaS Billing ‚Äî —Å–∏—Å—Ç–µ–º–∞ –±–∏–ª–ª–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è serverless‚Äë—Ñ—É–Ω–∫—Ü–∏–π –≤ Kubernetes/Knative, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç —Å—ã—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–∞–º –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ–Ω—ã–º –ø–ª–∞–Ω–∞–º —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å—á–µ—Ç–æ–≤ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥—É—â–∏—Ö –∑–∞—Ç—Ä–∞—Ç.


---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker Desktop —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º Kubernetes (context: `docker-desktop`)
- kubectl, docker, helm
- –ü–æ—Ä—Ç 5000 —Å–≤–æ–±–æ–¥–µ–Ω (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä)

### –ó–∞–ø—É—Å–∫ 
1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Knative + Kourier, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–∞–∑–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
```
chmod +x scripts/setup-k8s.sh scripts/setup-prometheus.sh scripts/deploy-all.sh
./scripts/setup-k8s.sh
```

2) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Prometheus/Grafana —Å—Ç–µ–∫
```
./scripts/setup-prometheus.sh
```

3) –°–æ–±—Ä–∞—Ç—å –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
```
./scripts/deploy-all.sh
```

4) –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (PostgreSQL, Redis, Backend)
```
docker-compose up -d
```

5) End-to-end —Ç–µ—Å—Ç

```
./scripts/test-e2e.sh
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```
kubectl get ksvc,deploy,svc -A | grep -E "(waiter|queue|saver|billing)"
```

–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é waiter

```
curl -H "Host: waiter.default.knative.demo.com"
"http://localhost/invoke?sleep_ms=200&mem_mb=50"
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏

```
curl -H "Host: waiter.default.knative.demo.com" "http://localhost/metrics"
```

–¢–µ—Å—Ç –±–∏–ª–ª–∏–Ω–≥–∞

```
curl -X POST http://localhost:8080/api/v1/billing/calculate
-H "Content-Type: application/json"
-d '{"tenant_id":"demo","period_start":"2025-10-15T00:00:00Z","period_end":"2025-10-15T23:59:59Z"}'
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –û–±—â–∞—è –∏–¥–µ—è
–°–∏—Å—Ç–µ–º–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è serverless-—Ñ—É–Ω–∫—Ü–∏–π (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–∞—è –ø–∞–º—è—Ç—å, —Ö–æ–ª–æ–¥–Ω—ã–µ —Å—Ç–∞—Ä—Ç—ã), –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≥–∏–±–∫–∏–º —Ç–∞—Ä–∏—Ñ–Ω—ã–º –ø–ª–∞–Ω–∞–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ML-–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ø–æ —Å—Ö–µ–º–µ)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü–∞–ø–∫–∞ | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ |
|-----------|------------|-------|-----------|
| **user-container** | Serverless-—Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `waiter-service/`, `hello-service/`, `echo-service/` | Go/Gin, Python, Knative |
| **queue-proxy** | –°–±–æ—Ä –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –º–µ—Ç—Ä–∏–∫ | `queue-proxy/` | Go/Gin + Redis |
| **billing-agent** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç—Ä–∏–∫, –¥–µ—Ç–µ–∫—Ü–∏—è —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤ | `billing-agent/` | Go + cgroups/RAM monitoring |
| **saver** | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Redis –≤ PostgreSQL | `saver/` | Go + GORM |
| **billing-API** | REST API –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤, –æ—Ç—á—ë—Ç–æ–≤, —Ç–∞—Ä–∏—Ñ–æ–≤ | `backend/` | Go/Gin + PostgreSQL |
| **PostgreSQL** | –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –±–∏–ª–ª–∏–Ω–≥–∞ | `deployment/postgres/` | PostgreSQL 15 |
| **Redis** | –ö–µ—à –∏ –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π | `deployment/redis/` | Redis 7 |
| **Frontend** | –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏ –æ—Ç—á—ë—Ç–æ–≤ | `frontend/` (–Ω–µ –≤ –¥–µ—Ä–µ–≤–µ) | React/Next.js |
| **AI –º–æ–¥—É–ª—å** | ML-–ø—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | `ml/` | Python/scikit-learn |

---

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (PostgreSQL)

#### Tenants (–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| name | VARCHAR(255) | –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| billing_email | VARCHAR(255) | Email –¥–ª—è —Å—á–µ—Ç–æ–≤ |
| currency | VARCHAR(3) | –í–∞–ª—é—Ç–∞ (RUB, USD) |
| timezone | VARCHAR(50) | –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ |

#### Services (–°–µ—Ä–≤–∏—Å—ã/–§—É–Ω–∫—Ü–∏–∏)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| tenant_id | UUID | FK –Ω–∞ Tenants |
| name | VARCHAR(255) | –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ |
| namespace | VARCHAR(255) | K8s namespace |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| runtime | VARCHAR(50) | go, python, nodejs |
| memory_limit_mb | INTEGER | –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ |
| cpu_limit_cores | DECIMAL(3,2) | –õ–∏–º–∏—Ç CPU |

#### Revisions (–†–µ–≤–∏–∑–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| service_id | UUID | FK –Ω–∞ Services |
| name | VARCHAR(255) | –ò–º—è —Ä–µ–≤–∏–∑–∏–∏ (waiter-00001) |
| image | VARCHAR(500) | Docker –æ–±—Ä–∞–∑ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| config_env | JSONB | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è |
| scaling_config | JSONB | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥–∞ |

#### UsageRaw (–°—ã—Ä—ã–µ –º–µ—Ç—Ä–∏–∫–∏)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | BIGSERIAL | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| timestamp | TIMESTAMP | –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è |
| tenant_id | UUID | FK –Ω–∞ Tenants |
| service_id | UUID | FK –Ω–∞ Services |
| revision_id | UUID | FK –Ω–∞ Revisions |
| metric_name | VARCHAR(100) | invocations, duration_ms, memory_mb |
| value | DECIMAL(15,6) | –ó–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ |
| labels | JSONB | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ |
| request_id | VARCHAR(255) | ID –∑–∞–ø—Ä–æ—Å–∞ (—Ç—Ä–µ–π—Å–∏–Ω–≥) |

#### UsageAggregate (–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | BIGSERIAL | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| window_start | TIMESTAMP | –ù–∞—á–∞–ª–æ –æ–∫–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ |
| window_end | TIMESTAMP | –ö–æ–Ω–µ—Ü –æ–∫–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ |
| window_size | VARCHAR(10) | 5m, 1h, 1d |
| tenant_id | UUID | FK –Ω–∞ Tenants |
| service_id | UUID | FK –Ω–∞ Services |
| revision_id | UUID | FK –Ω–∞ Revisions |
| invocations | BIGINT | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ |
| total_duration_ms | BIGINT | –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| avg_duration_ms | DECIMAL(10,3) | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| p50_duration_ms | DECIMAL(10,3) | –ú–µ–¥–∏–∞–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ |
| p95_duration_ms | DECIMAL(10,3) | 95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å |
| max_memory_mb | DECIMAL(10,3) | –ü–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ |
| avg_memory_mb | DECIMAL(10,3) | –°—Ä–µ–¥–Ω–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ |
| cold_starts | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤ |
| errors | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ |

#### PricingPlans (–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| name | VARCHAR(255) | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ |
| tenant_id | UUID | FK –Ω–∞ Tenants (NULL = –æ–±—â–∏–π) |
| currency | VARCHAR(3) | –í–∞–ª—é—Ç–∞ |
| price_per_invocation | DECIMAL(10,6) | –¶–µ–Ω–∞ –∑–∞ –≤—ã–∑–æ–≤ |
| price_per_mb_ms | DECIMAL(10,6) | –¶–µ–Ω–∞ –∑–∞ –ú–ë√ó–º—Å |
| price_per_cold_start | DECIMAL(10,6) | –¶–µ–Ω–∞ –∑–∞ —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç |
| price_per_cpu_ms | DECIMAL(10,6) | –¶–µ–Ω–∞ –∑–∞ –º—Å CPU |
| free_tier_invocations | BIGINT | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤—ã–∑–æ–≤—ã/–º–µ—Å—è—Ü |
| free_tier_mb_ms | BIGINT | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ú–ë√ó–º—Å/–º–µ—Å—è—Ü |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| active | BOOLEAN | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–∞—Ä–∏—Ñ |

#### Bills (–°—á–µ—Ç–∞)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| tenant_id | UUID | FK –Ω–∞ Tenants |
| period_start | TIMESTAMP | –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ |
| period_end | TIMESTAMP | –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ |
| total_amount | DECIMAL(15,2) | –û–±—â–∞—è —Å—É–º–º–∞ |
| currency | VARCHAR(3) | –í–∞–ª—é—Ç–∞ |
| status | VARCHAR(50) | draft, final, paid |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| line_items | JSONB | –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—å—è–º |

#### ML_Predictions (ML-–ø—Ä–æ–≥–Ω–æ–∑—ã)
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| tenant_id | UUID | FK –Ω–∞ Tenants |
| service_id | UUID | FK –Ω–∞ Services (NULL = –æ–±—â–∏–π) |
| prediction_date | DATE | –î–∞—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ |
| horizon_days | INTEGER | –ì–æ—Ä–∏–∑–æ–Ω—Ç (1, 7, 30 –¥–Ω–µ–π) |
| predicted_invocations | BIGINT | –ü—Ä–æ–≥–Ω–æ–∑ –≤—ã–∑–æ–≤–æ–≤ |
| predicted_cost | DECIMAL(15,2) | –ü—Ä–æ–≥–Ω–æ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ |
| confidence | DECIMAL(5,4) | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (0-1) |
| model_version | VARCHAR(50) | –í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

---

## –¢–µ–∫—É—â–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### waiter-service (–¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
**–õ–æ–∫–∞—Ü–∏—è**: `waiter-service/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Go/Gin, Knative Service  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥–∞ –∏ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫

#### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/invoke` | –≠–º—É–ª—è—Ü–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏: `?sleep_ms=200&mem_mb=50&cpu_spin_ms=100` |
| GET | `/metrics` | Prometheus-–º–µ—Ç—Ä–∏–∫–∏ |
| GET | `/healthz` | Health check |
| GET | `/readiness` | Readiness probe |

#### –°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- `waiter_requests_total{method,endpoint,status}` ‚Äî —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
- `waiter_request_duration_seconds` ‚Äî –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `waiter_memory_usage_bytes` ‚Äî —Ç–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- `waiter_cold_starts_total` ‚Äî —Å—á—ë—Ç—á–∏–∫ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤

### queue-proxy (–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π)
**–õ–æ–∫–∞—Ü–∏—è**: `queue-proxy/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Go/Gin + Redis  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–∏—ë–º –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –º–µ—Ç—Ä–∏–∫

#### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| POST | `/metrics/collect` | –ü—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π –º–µ—Ç—Ä–∏–∫ (–æ–¥–∏–Ω–æ—á–Ω–æ/–±–∞—Ç—á–æ–º) |
| POST | `/metrics/pop` | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| GET | `/metrics` | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ |
| GET | `/healthz` | Health check |

#### –§–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏–π:
```
{
"timestamp": "2025-10-15T12:00:00Z",
"tenant_id": "demo-tenant",
"service_name": "waiter",
"revision": "waiter-00001",
"invocations": 1,
"duration_seconds": 0.234,
"memory_mb": 64.5,
"cold_start": false,
"labels": {"method": "GET", "status": "200"}
}
```

### saver (–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

**–õ–æ–∫–∞—Ü–∏—è**: `saver/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Go + GORM + PostgreSQL  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ Redis –≤ PostgreSQL

#### –§—É–Ω–∫—Ü–∏–∏:
- –ß–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Redis –æ—á–µ—Ä–µ–¥–∏ (`metrics_queue`)
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É `UsageRaw`
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–∞—Ç—á–µ–≤—É—é –≤—Å—Ç–∞–≤–∫—É –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

### billing-agent (–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ—Ç—Ä–∏–∫)
**–õ–æ–∫–∞—Ü–∏—è**: `billing-agent/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Go + —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç—Ä–∏–∫, –¥–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π

#### –§—É–Ω–∫—Ü–∏–∏:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ cgroups
- –î–µ—Ç–µ–∫—Ü–∏—è —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –†–∞—Å—á—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ (p50, p95, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ billing-API

### backend (Billing API)
**–õ–æ–∫–∞—Ü–∏—è**: `backend/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Go/Gin + PostgreSQL + GORM  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π API –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞, –æ—Ç—á—ë—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### –ì–æ—Ç–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-------|------|----------|--------|
| GET | `/api/v1/health` | Health check | ‚úÖ –ì–æ—Ç–æ–≤ |
| POST | `/api/v1/tenants` | –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ | ‚úÖ –ì–æ—Ç–æ–≤ |
| GET | `/api/v1/tenants` | –°–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤ |
| GET | `/api/v1/tenants/:id` | –î–µ—Ç–∞–ª–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ | ‚úÖ –ì–æ—Ç–æ–≤ |
| POST | `/api/v1/services` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ | ‚úÖ –ì–æ—Ç–æ–≤ |
| GET | `/api/v1/services` | –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤ |

#### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-------|------|----------|--------|
| POST | `/api/v1/metrics/ingest` | –ü—Ä–∏—ë–º —Å—ã—Ä—ã—Ö –º–µ—Ç—Ä–∏–∫ | üîÑ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ |
| POST | `/api/v1/metrics/aggregate` | –ó–∞–ø—É—Å–∫ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ | üîÑ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ |
| POST | `/api/v1/billing/calculate` | –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ | üîÑ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ |
| GET | `/api/v1/billing/reports/:tenant_id` | –û—Ç—á—ë—Ç—ã –ø–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä—É | üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è |
| POST | `/api/v1/pricing/plans` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏ | üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è |
| GET | `/api/v1/usage/dashboard/:tenant_id` | –î–∞—à–±–æ—Ä–¥ –º–µ—Ç—Ä–∏–∫ | üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è |

### hello-service & echo-service (–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
**–õ–æ–∫–∞—Ü–∏—è**: `hello-service/`, `echo-service/`  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Python, ealen/echo-server  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

---

## –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

### PostgreSQL (–û—Å–Ω–æ–≤–Ω–∞—è –ë–î)
**–õ–æ–∫–∞—Ü–∏—è**: `deployment/postgres/init.sql`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã
- –°—Ö–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã foreign keys –∏ constraints –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### Redis (–ö–µ—à –∏ –æ—á–µ—Ä–µ–¥–∏)
**–õ–æ–∫–∞—Ü–∏—è**: `deployment/redis/redis.yml`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: 
- –û—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –º–µ—Ç—Ä–∏–∫ (`metrics_queue`)
- –ö–µ—à —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–∞—Ä–∏—Ñ—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- Session storage –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### Prometheus + Grafana (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
**–õ–æ–∫–∞—Ü–∏—è**: `deployment/prometheus/`, `deployment/grafana/`  
**–ù–∞—Å—Ç—Ä–æ–π–∫–∏**:
- –ê–≤—Ç–æ–¥–∏—Å–∫–∞–≤–µ—Ä–∏ Knative Services –ø–æ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º
- –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫ —Ñ—É–Ω–∫—Ü–∏–π
- –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∞–Ω–æ–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## –ê–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ –∏ Kubernetes

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ Knative:
1. **Scale-to-zero**: –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ–¥—ã —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
2. **Cold start**: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø—Ä–æ—Å—Ç–æ—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ–¥ (~1-3 —Å–µ–∫)
3. **Concurrency-based scaling**: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **Custom metrics**: –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ custom –º–µ—Ç—Ä–∏–∫–∞–º

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥–∞ (–ø—Ä–∏–º–µ—Ä):
```
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
name: waiter
spec:
template:
metadata:
annotations:
autoscaling.knative.dev/minScale: "0" # Scale-to-zero
autoscaling.knative.dev/maxScale: "10" # –ú–∞–∫—Å–∏–º—É–º –ø–æ–¥–æ–≤
autoscaling.knative.dev/target: "100" # –¶–µ–ª–µ–≤–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
autoscaling.knative.dev/metric: "concurrency" # –ú–µ—Ç—Ä–∏–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
autoscaling.knative.dev/class: "kpa.autoscaling.knative.dev"
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
1. **–°–æ–∑–¥–∞—Ç—å Dockerfile** —Å –≤–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –Ω–∞ –ø–æ—Ä—Ç—É 8080
2. **–°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—à–∏—Ç—å –æ–±—Ä–∞–∑**:
```
docker build -t myfunction:latest .
docker tag myfunction:latest localhost:5000/myfunction:latest
docker push localhost:5000/myfunction:latest
```

3. **–°–æ–∑–¥–∞—Ç—å Knative Service –º–∞–Ω–∏—Ñ–µ—Å—Ç**:

```
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
name: myfunction
spec:
template:
metadata:
annotations:
prometheus.io/scrape: "true"
prometheus.io/path: "/metrics"
prometheus.io/port: "8080"
spec:
containers:
- image: localhost:5000/myfunction:latest
ports:
- containerPort: 8080
```

4. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç**: 
```
`kubectl apply -f myfunction.yml`
```

---

## –¢–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º:
| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `*_requests_total` | Counter | –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| `*_request_duration_seconds` | Histogram | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| `*_memory_usage_bytes` | Gauge | –¢–µ–∫—É—â–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ |
| `*_cold_starts_total` | Counter | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤ |
| `*_errors_total` | Counter | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ |

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
| –°–µ—Ä–≤–∏—Å | –ú–µ—Ç—Ä–∏–∫–∏ |
|--------|---------|
| queue-proxy | –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –æ—à–∏–±–∫–∏ |
| saver | –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏, –∑–∞–¥–µ—Ä–∂–∫–∏ –ë–î, failed operations |
| billing-agent | –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–±—ã—Ç–∏–π, –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| backend | HTTP –º–µ—Ç—Ä–∏–∫–∏, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API, –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è |

---

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
**–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 1 —á–∞—Å / 1 –¥–µ–Ω—å / 1 –Ω–µ–¥–µ–ª—é.**

1) –ë–µ—Ä—ë—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑ UsageAggregate.
2) –°—á–∏—Ç–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å: invocations + memory + cold starts * price.
**–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:**
Frontend:
- invocations ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ —Å–µ—Ä–≤–∏—Å–∞.
- memory ‚Äî –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (MB√óms).
- cold_starts ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤.
- total_cost ‚Äî –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å.
- line_items ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç–∞.
ML:
- ForecastRequest:
- tenant_id ‚Äî –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä.
- period ‚Äî "1h", "1d", "1w".
- ForecastResponse:
- forecasted_cost ‚Äî –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å.
- components ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è (invocations, memory, cold starts)

## –ü–ª–∞–Ω –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –±–∏–ª–ª–∏–Ω–≥–∞ 

#### Backend —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
1. **POST /api/v1/metrics/ingest**
- –ü—Ä–∏—ë–º –±–∞—Ç—á–µ–π UsageRaw –∏–∑ saver
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- Bulk insert –≤ PostgreSQL

2. **POST /api/v1/metrics/aggregate** 
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è UsageRaw –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–∞–º (5m, 1h, 1d)
- –†–∞—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ (avg, p50, p95, max)
- –ó–∞–ø–∏—Å—å –≤ UsageAggregate

3. **POST /api/v1/billing/calculate**
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤

4. **GET/POST /api/v1/pricing/plans**
- CRUD –¥–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤

5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ—É–Ω–∫—Ü–∏–π –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –µ—ë –ø—Ä–∏—ë–º–∞ –∏ –ø–æ–º–æ—â–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä**
   
#### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:
- Cron job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- Cleanup —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (retention policy)
- –ë—ç–∫–∞–ø—ã PostgreSQL

### –§–∞–∑–∞ 2: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –¥–∞—à–±–æ—Ä–¥—ã 

#### Frontend (React/Next.js):
1. **–î–∞—à–±–æ—Ä–¥ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞**:
- –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- Breakdown –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º –∏ —Ä–µ–≤–∏–∑–∏—è–º
- –¢–µ–∫—É—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü

2. **–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã**:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º, —Å–µ—Ä–≤–∏—Å–∞–º, —Ç–µ–≥–∞–º
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/PDF
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤

3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏**:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω –∏ free tier
- –°–∏–º—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–∞—Ä–∏—Ñ–æ–≤

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π**:
- –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏ –∏ —Ç—Ä–µ–π—Å–∏–Ω–≥

#### API —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
- WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- GraphQL endpoint –¥–ª—è –≥–∏–±–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞

### –§–∞–∑–∞ 3: ML –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ 

#### ML –º–æ–¥—É–ª—å (Python/scikit-learn):
1. **–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤**:
```
ml/models/cost_prediction.py
Time series forecasting (ARIMA, Prophet)
```

**–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ —Ç—Ä–µ–Ω–¥—ã**

**–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã**


2. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:

ml/models/optimization.py
1) –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

2) –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ memory/CPU limits

3) –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥–∞


3. **–î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π**:
ml/models/anomaly_detection.py

1) –ù–µ–æ–±—ã—á–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

2) –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—Ä–∞—Ñ–∏–∫–∞

3) –ê–ª–µ—Ä—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏


#### ML API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| POST | `/api/v1/ml/predict` | –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤ |
| POST | `/api/v1/ml/optimize` | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ |
| POST | `/api/v1/ml/anomalies` | –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π |
| GET | `/api/v1/ml/insights/:tenant_id` | –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã |

#### –§–∏—á–∏ ML:
- **–ü—Ä–æ–≥–Ω–æ–∑ –±—é–¥–∂–µ—Ç–∞**: "–ü—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–µ–Ω–¥–∞—Ö –º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–æ—Å—Ç–∞–≤—è—Ç X‚ÇΩ"
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è**: "–£–≤–µ–ª–∏—á—å—Ç–µ minScale –¥–æ 2 –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ A"  
- **Cost optimization**: "–°–º–µ–Ω–∏—Ç–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ 15%"
- **Capacity planning**: "–î–æ–±–∞–≤—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏"

### –§–∞–∑–∞ 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏

#### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:
1. **Multi-tenancy**:
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º–∏
- –û–±—â–∏–µ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
- Billing –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º

2. **Advanced pricing**:
- –¢–∞—Ä–∏—Ñ—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫/–¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
- Volume discounts
- Reserved capacity pricing
- Spot pricing –¥–ª—è –Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á

3. **Integration & Export**:
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ —É—á—ë—Ç–∞
- API –¥–ª—è –±–∏–ª–ª–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç –≤ 1–°, SAP
- Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

4. **Compliance & Security**:
- GDPR compliance –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Audit logs –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Role-based access control (RBAC)
- Encryption at rest and in transit

---


